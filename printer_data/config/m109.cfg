[gcode_macro M109]
rename_existing: M109.9999
gcode:
    {% set s = params.S|float %}
    {% set tn = params.T|default(printer.tool_probe_endstop.active_tool_number)|int %}
    {% set tool = printer.toolchanger.tool_names[tn]|default('') %}
    {% set extruder = printer[tool].extruder %}
    
    M104 {rawparams}  ; Set hotend temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR={extruder} MINIMUM={s-5} MAXIMUM={s+5}   ; Wait for hotend temp (within 3 degrees)
    {% endif %}