[save_variables]
filename: ~/printer_data/config/variables.cfg

[gcode_macro T0]
gcode:
  MAP_TOOL T=0

[gcode_macro T1]
gcode:
  MAP_TOOL T=1

[gcode_macro T2]
gcode:
  MAP_TOOL T=2

[gcode_macro T3]
gcode:
  MAP_TOOL T=3

[gcode_macro T4]
gcode:
  MAP_TOOL T=4
  
[gcode_macro MAP_TOOL]
gcode:
  {% set tool = params.T | int %}
  {% if printer.save_variables.variables.tool_remap is string %}
    {% set remap = printer.save_variables.variables.tool_remap.split(',') %}
  {% else %}
    {% set remap = printer.save_variables.variables.tool_remap %}
  {% endif %}
  
  {% if tool >= 0 and tool < remap | count %}
    {% set target_tool = remap[tool] | int %}
    SELECT_TOOL T={target_tool}
  {% else %}
    {action_raise_error("Tool index out of range.")}
  {% endif %}

[gcode_macro M104] #needed for tool preheat
rename_existing: M104.1
gcode:
  {% set tool = params.T | int %}
  {% if printer.save_variables.variables.tool_remap is string %}
    {% set remap = printer.save_variables.variables.tool_remap.split(',') %}
  {% else %}
    {% set remap = printer.save_variables.variables.tool_remap %}
  {% endif %}
  
  {% if tool >= 0 and tool < remap | count %}
    {% set target_tool = remap[tool] | int %}
    M104.1 S{params.S} T{target_tool}
  {% else %}
    {action_raise_error("Tool index out of range.")}
  {% endif %}


[gcode_macro INIT_TOOL_MAPPING]
description: "Initialize tool mapping"
gcode:
  SAVE_VARIABLE VARIABLE=tool_remap VALUE="0,1,2,3,4"

[gcode_macro SET_TOOL_MAPPING]
gcode:
  {% if params.TOOL is defined and params.MAPS_TO is defined %}
    {% set tool = params.TOOL | int %}
    {% set maps_to = params.MAPS_TO | int %}
    {% if tool >= 0 and tool <= 4 and maps_to >= 0 and maps_to <= 4 %}
      {% if printer.save_variables.variables.tool_remap is string %}
        {% set remap = printer.save_variables.variables.tool_remap.split(',') %}
      {% else %}
        {% set remap = printer.save_variables.variables.tool_remap %}
      {% endif %}
      
      {% set remap = remap[:tool] + [maps_to | string] + remap[tool+1:] %}
      {% set new_remap = remap | join(',') %}
      SAVE_VARIABLE VARIABLE=tool_remap VALUE='{new_remap}'
    {% else %}
      {action_raise_error("Tool numbers must be 0-4.")}
    {% endif %}
  {% else %}
    {action_raise_error("Specify TOOL and MAPS_TO parameters.")}
  {% endif %}

[gcode_macro SET_ALL_TOOL_MAPPING]
gcode:
  {% if params.MAPPING %}
    {% set mapping = params.MAPPING.split(',') %}
    {% if mapping | count == 5 %}
      {% for val in mapping %}
        {% if val.strip() not in ['0','1','2','3','4'] %}
          {action_raise_error("Invalid tool number in mapping.")}
        {% endif %}
      {% endfor %}
      SAVE_VARIABLE VARIABLE=tool_remap VALUE='{params.MAPPING}'
    {% else %}
      {action_raise_error("Mapping must have 5 values (e.g., '0,2,1,3,4').")}
    {% endif %}
  {% else %}
    {action_raise_error("Specify MAPPING parameter.")}
  {% endif %}
  
[gcode_macro VIEW_TOOL_MAPPING]
gcode:
  RESPOND TYPE=echo MSG='{printer.save_variables.variables.tool_remap}'
