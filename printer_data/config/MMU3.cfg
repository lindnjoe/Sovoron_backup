[save_variables]
filename: ~/printer_data/config/variables.cfg


[gcode_macro SELECT_TOOL]
rename_existing: SELECT_TOOL1
gcode:
  
    {% set curtool = params.T | int %}
     
   {% if curtool == 0 or curtool == 1 or curtool == 2 or curtool == 3 or curtool == 4 or curtool == 5 %}
    SELECT_TOOL1 T={curtool}
    
    {% else %}
     SELECT_TOOL1 T=5
     H{params.T}.1
   {% endif %}
 


[gcode_macro PRE_LOAD_6]
description: Loads the filament 6 into the extruder bowden
gcode:
  {% set TOOL=printer["gcode_macro TOOL_INIT"].tool %}
  {% set SPEED=printer["gcode_macro TOOL_INIT"].chameleon_speed %}
  {% set ACC=printer["gcode_macro TOOL_INIT"].chameleon_acc %}
  
  TOOL_SELECT TOOL=6
  
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  
  M117 "Move tool {TOOL} by 50"
  MANUAL_STEPPER stepper=chameleon1 MOVE=50 SPEED={SPEED} ACCEL={ACC}
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=tool VALUE={TOOL}
  G92 E0
  M400

[gcode_macro PRE_LOAD_7]
description: Loads the filament 7 into the extruder bowden
gcode:
  {% set TOOL=printer["gcode_macro TOOL_INIT"].tool %}
  {% set SPEED=printer["gcode_macro TOOL_INIT"].chameleon_speed %}
  {% set ACC=printer["gcode_macro TOOL_INIT"].chameleon_acc %}
  
  TOOL_SELECT TOOL=7
  
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  
  M117 "Move tool {TOOL} by 50"
  MANUAL_STEPPER stepper=chameleon1 MOVE=50 SPEED={SPEED} ACCEL={ACC}
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=tool VALUE={TOOL}
  
  G92 E0
  M400


[gcode_macro PRE_LOAD_8]
description: Loads the filament 8 into the extruder bowden
gcode:
  {% set TOOL=printer["gcode_macro TOOL_INIT"].tool %}
  {% set SPEED=printer["gcode_macro TOOL_INIT"].chameleon_speed %}
  {% set ACC=printer["gcode_macro TOOL_INIT"].chameleon_acc %}
  
  TOOL_SELECT TOOL=8
  
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0

  M117 "Move tool {TOOL} by -50"
  MANUAL_STEPPER stepper=chameleon1 MOVE=-50 SPEED={SPEED} ACCEL={ACC}
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=tool VALUE={TOOL}
  G92 E0
  M400

[gcode_macro PRE_LOAD_9]
description: Loads the filament 9 into the extruder bowden
gcode:
  {% set TOOL=printer["gcode_macro TOOL_INIT"].tool %}
  {% set SPEED=printer["gcode_macro TOOL_INIT"].chameleon_speed %}
  {% set ACC=printer["gcode_macro TOOL_INIT"].chameleon_acc %}
  
  TOOL_SELECT TOOL=9
  
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
 
  M117 "Move tool {TOOL} by -50"
  MANUAL_STEPPER stepper=chameleon1 MOVE=-50 SPEED={SPEED} ACCEL={ACC}
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=tool VALUE={TOOL}
  G92 E0
  M400

# [gcode_macro _Clippy_Chop]
# description: Perform the clippy chop.
# variable_clippy_servo_name: 'clippy'
# variable_clippy_minimum_angle: 120 # Idle position
# variable_clippy_cut_angle: 0 # Cutting position
# variable_x_cut_position: 2.0 # Position for the cut
# gcode:
#  G90
#  G1 X20 Y338.19 F16000
#  SET_TMC_CURRENT STEPPER=stepper_x CURRENT=2.0
#  SET_TMC_CURRENT STEPPER=stepper_y CURRENT=2.0
#  SET_SERVO SERVO={clippy_servo_name} ANGLE={clippy_cut_angle}
#  M400
#  G1 X{x_cut_position} F300
#  G4 P1450
#  G1 X80 F16000
#  SET_TMC_CURRENT STEPPER=stepper_x CURRENT=1.13
#  SET_TMC_CURRENT STEPPER=stepper_y CURRENT=1.13
#  SET_SERVO SERVO={clippy_servo_name} ANGLE={clippy_minimum_angle}

# Consolidated Klipper Macros for Multi-Tool Filament Handling

[gcode_macro _Clippy_Chop]
gcode:
    {% set moves = params.MOVES | default(7) | int %}
    M83
    {% for _ in range(moves) %}
        G92 E0
        G1 E10 F1500
        G92 E0
        G1 E-15 F1500
    {% endfor %}
    G1 E-40 F2000
    G92 E0

[gcode_macro CHECK_FILAMENT_SENSOR]
gcode:
    SET_FILAMENT_SENSOR SENSOR=filament_sensor_T5 ENABLE=1
    M117 "Checking filament sensor..."
    {% if not printer['filament_switch_sensor filament_sensor_T5'].filament_detected %}
        M117 "Filament not detected! Pausing..."
        PAUSE
    {% else %}
        M117 "Filament detected, continuing..."
    {% endif %}

[gcode_macro _global_var]
variable_pause_park: {'x': 30, 'y': 300, 'z': 10, 'e': 1}
variable_cancel_park: {'x': 30, 'y': 300, 'z': 10, 'e': 1}
variable_z_maximum_lifting_distance: 345
variable_pause_resume_travel_speed: 150
variable_bed_mesh_calibrate_target_temp: 60
variable_load_filament_extruder_temp: 220
gcode:

[gcode_macro TOOL_INIT]
description: Homes the tool selector. Needed before any tool change.
variable_tool: 10
variable_ysplit_distance: 1900  # Configurable split distance
variable_chameleon_speed: 90
variable_chameleon_acc: 50
variable_restore: 10
gcode:
    MANUAL_STEPPER STEPPER=selector1 SET_POSITION=0
    MANUAL_STEPPER STEPPER=selector1 MOVE=-1.65
    MANUAL_STEPPER STEPPER=selector1 SET_POSITION=0
    MANUAL_STEPPER STEPPER=selector1 MOVE=0.181  # Configurable position
    MANUAL_STEPPER STEPPER=selector1 SET_POSITION=0
    MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
    SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=tool VALUE=10

[gcode_macro TOOL_SELECT]
gcode:
    {% set TOOL = params.TOOL | int %}
    M117 "Setting tool to TOOL{TOOL}"
    {% set tool_positions = {
        6: 0,
        7: 0.5,
        8: 1.0,
        9: 1.5
    } %}
    MANUAL_STEPPER stepper=selector1 MOVE={tool_positions[TOOL]}
    SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=tool VALUE={TOOL}

[gcode_macro TOOL_FREE]
gcode:
    {% set TOOL = params.TOOL | int %}
    M117 "Free filament path for tool {TOOL}"
    {% set tool_free_positions = {
        6: 1,
        7: 1.5,
        8: 0,
        9: 0.5
    } %}
    MANUAL_STEPPER stepper=selector1 MOVE={tool_free_positions[TOOL]}

[gcode_macro CHAMELEON_LOAD]
description: Loads the filament into the extruder bowden
gcode:
    {% set TOOL = printer["gcode_macro TOOL_INIT"].tool %}
    {% set YSPLIT_DIST = printer["gcode_macro TOOL_INIT"].ysplit_distance %}
    {% set SPEED = printer["gcode_macro TOOL_INIT"].chameleon_speed %}
    {% set ACC = printer["gcode_macro TOOL_INIT"].chameleon_acc %}
    
    MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
    
    {% if TOOL in [6, 7] %}
        M117 "Move tool {TOOL} by {YSPLIT_DIST-60}"
        MANUAL_STEPPER stepper=chameleon1 MOVE={YSPLIT_DIST-60} SPEED={SPEED} ACCEL={ACC}
    {% elif TOOL in [8, 9] %}
        M117 "Move tool {TOOL} by -{YSPLIT_DIST-60}"
        MANUAL_STEPPER stepper=chameleon1 MOVE=-{YSPLIT_DIST-60} SPEED={SPEED} ACCEL={ACC}
    {% endif %}
    
    MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
    G92 E0
    M400

[gcode_macro _EXTRUDER_UNLOAD]
description: Unloads the filament from the extruder before a tool change
gcode:
    M83
    G92 E0
    _Clippy_Chop MOVES=7
    G92 E0
    {action_respond_info("Filament Cut")}

[gcode_macro EXTRUDER_LOAD]
description: Loads the filament in the extruder after a tool change
gcode:
    M83
    M106 S255  # Full fan speed during load
    G92 E0
    G1 E120 F600  # First load
    G92 E0
    G1 E120 F600  # Second load
    G92 E0
    G1 E-3 F250  # Retract slightly
    M106 S0  # Turn off fan
    G92 E0
    {action_respond_info("Extruder Loaded")}


[gcode_macro CHAMELEON_UNLOAD]
description: Unloads the filament from the tubing
gcode:
    {% set TOOL = printer["gcode_macro TOOL_INIT"].tool %}
    {% set YSPLIT_DIST = printer["gcode_macro TOOL_INIT"].ysplit_distance %}
    {% set SPEED = printer["gcode_macro TOOL_INIT"].chameleon_speed %}
    {% set ACC = printer["gcode_macro TOOL_INIT"].chameleon_acc %}
    
    MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
    
    {% set unload_direction = -1 if TOOL in [6, 7] else 1 %}
    M117 "Move tool {TOOL} by {unload_direction * YSPLIT_DIST}"
    
    MANUAL_STEPPER stepper=chameleon1 
        MOVE={unload_direction * YSPLIT_DIST} 
        SPEED={SPEED} 
        ACCEL={ACC} 
        SET_POSITION=0 
        SYNC=0
    
    G92 E0
    G1 E-530 F3600
    MANUAL_STEPPER STEPPER=chameleon1 SYNC=1
    MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0

[gcode_macro TOOL_UNLOAD]
gcode:
    {% set RESTORE = printer["gcode_macro TOOL_INIT"].restore %}
    {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp | int %}
    
    {% if RESTORE in [6, 7, 8, 9] %}
        SELECT_TOOL1 T=5
        SET_FILAMENT_SENSOR SENSOR=filament_sensor_T5 ENABLE=0
        
        G92 E0
        M109 S190 T5
        _EXTRUDER_UNLOAD
        
        TOOL_SELECT TOOL={RESTORE}
        G4 P250
        CHAMELEON_UNLOAD
        
        M104 S0
        SELECT_TOOL1 T=0
        TOOL_INIT
        {action_respond_info("Tool Unloaded")}
    {% endif %}
    
    M400
    SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=restore VALUE=10
    M104 S0

# Individual Tool Select Macros
[gcode_macro TS6] 
gcode: TOOL_SELECT TOOL=6

[gcode_macro TS7] 
gcode: TOOL_SELECT TOOL=7

[gcode_macro TS8] 
gcode: TOOL_SELECT TOOL=8

[gcode_macro TS9] 
gcode: TOOL_SELECT TOOL=9

# Simplified Filament Handling Macros
[gcode_macro H6.1]
gcode: _COMMON_TOOL_CHANGE TARGET_TOOL=6

[gcode_macro H7.1]
gcode: _COMMON_TOOL_CHANGE TARGET_TOOL=7

[gcode_macro H8.1]
gcode: _COMMON_TOOL_CHANGE TARGET_TOOL=8

[gcode_macro H9.1]
gcode: _COMMON_TOOL_CHANGE TARGET_TOOL=9

[gcode_macro _COMMON_TOOL_CHANGE]
gcode:
    {% set target_tool = params.TARGET_TOOL | int %}
    {% set current_tool = printer["gcode_macro TOOL_INIT"].tool %}
    {% set restore = printer["gcode_macro TOOL_INIT"].restore %}
    {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp | int %}
    {% set current_target_temp = printer.extruder.target | int %}
    
    # Check if target tool is already the current or restored tool
    {% if target_tool == current_tool or target_tool == restore %}
        {action_respond_info("Tool {target_tool} is already active. No action needed.")}
        M117 "Tool {target_tool} already active"
        G4 P0  # No-op to prevent further processing
        
    {% else %}
        # Heat nozzle if not already at temperature
        {% if printer.print_stats.state not in ["printing", "paused"] or printer.extruder.target == 0 %}
            M104 S{extruder_temp}
            M117 "Nozzle heating..."
            M109 S{extruder_temp}
        {% endif %}
        
        # Unload current tool if different
        {% if current_tool not in [0, target_tool] %}
            _EXTRUDER_UNLOAD
            UNSELECT_TOOL
            TOOL_SELECT TOOL={current_tool}
            CHAMELEON_UNLOAD
        {% endif %}
        
        # Select new tool
        TOOL_SELECT TOOL={target_tool}
        SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=tool VALUE={target_tool}
        
        UNSELECT_TOOL
        M109 S{extruder_temp} T5
        CHAMELEON_LOAD
        
        # Load filament
        M83
        G92 E0
        MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
        MANUAL_STEPPER STEPPER=chameleon1 
            MOVE={(1 if target_tool in [8, 9] else -1) * 280} 
            SPEED=10 
            SET_POSITION=0 
            SYNC=0
        G1 E280 F600
        MANUAL_STEPPER STEPPER=chameleon1 SYNC=1
        MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
        
        TOOL_FREE TOOL={target_tool}
        M400
        EXTRUDER_LOAD
        SELECT_TOOL1 T=5
        CHECK_FILAMENT_SENSOR
        
        # Optional: Cool down if not in print
        {% if current_target_temp == 0 or printer.print_stats.state not in ["printing", "paused"] %}
            M104 S0
        {% endif %}
        
        SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=restore VALUE={target_tool}
    {% endif %}