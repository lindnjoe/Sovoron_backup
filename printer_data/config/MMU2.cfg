[save_variables]
filename: ~/printer_data/config/variables.cfg

[gcode_macro CHECK_FILAMENT]
description: Check if filament is detected
gcode:
  M117 "Checking filament detection..."
  {% if filament_sensor_T5.is_filament_detected %}
    M117 "Filament detected!"
    SET GCODE_VARIABLE MACRO=LOAD_RETRY VARIABLE=filament_detected VALUE=1
  {% else %}
    M117 "No filament detected."
    SET GCODE_VARIABLE MACRO=LOAD_RETRY VARIABLE=filament_detected VALUE=0
  {% endif %}



[gcode_macro MOVE_TOOL]
description: Move tool stepper based on tool type
variable_YSPLIT_DIST: 30
variable_SPEED: 60
variable_ACC: 200
gcode:
  {% if TOOL == 6 or TOOL == 7 %}
    M117 "Moving tool {TOOL} by {YSPLIT_DIST}"
    MANUAL_STEPPER stepper=chameleon1 MOVE={YSPLIT_DIST} SPEED={SPEED} ACCEL={ACC}
    MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  {% elif TOOL == 8 or TOOL == 9 %}
    M117 "Moving tool {TOOL} by -{YSPLIT_DIST}"
    MANUAL_STEPPER stepper=chameleon1 MOVE=-{YSPLIT_DIST} SPEED={SPEED} ACCEL={ACC}
    MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  {% else %}
    M117 "Tool {TOOL} has no specific load movement logic."
  {% endif %}



[gcode_macro LOAD_RETRY]
description: Retry loading filament up to 5 times
variable_retry_count: 0
variable_max_retries: 5
variable_filament_detected: 0
gcode:
  M117 "Starting filament load retry process."
  SET GCODE_VARIABLE MACRO=LOAD_RETRY VARIABLE=retry_count VALUE=0
  SET GCODE_VARIABLE MACRO=LOAD_RETRY VARIABLE=filament_detected VALUE=0

  # Retry loop
  M117 "Filament load attempt 1 of 5."
  
  # Check filament sensor
  RUN_MACRO CHECK_FILAMENT
  
  {% if filament_detected == 0 %}
    # Move tool to try loading filament
    RUN_MACRO MOVE_TOOL
    
    # Check filament again after move
    RUN_MACRO CHECK_FILAMENT
    
    # Increase retry count
    SET GCODE_VARIABLE MACRO=LOAD_RETRY VARIABLE=retry_count VALUE={retry_count + 1}
  {% endif %}

  # If we have detected filament after 5 attempts, stop retry
  {% if filament_detected == 1 %}
    M117 "Filament successfully loaded!"
  {% endif %}

  # Error handling if max retries are reached and still no filament
  {% if retry_count >= max_retries %}
    M117 "Failed to load filament after 5 attempts."
    PAUSE
  {% endif %}



[gcode_macro LOAD_FILAMENT]
description: Load filament by calling retry macro
gcode:
  RUN_MACRO LOAD_RETRY





[gcode_macro PRE_LOAD_6]
description: Loads the filament 6 into the extruder bowden
gcode:
  {% set TOOL=printer["gcode_macro TOOL_INIT"].tool %}
  {% set SPEED=printer["gcode_macro TOOL_INIT"].chameleon_speed %}
  {% set ACC=printer["gcode_macro TOOL_INIT"].chameleon_acc %}
  
  TOOL_SELECT TOOL=6
  
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  
  M117 "Move tool {TOOL} by 50"
  MANUAL_STEPPER stepper=chameleon1 MOVE=50 SPEED={SPEED} ACCEL={ACC}
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0

  G92 E0
  M400

[gcode_macro PRE_LOAD_7]
description: Loads the filament 7 into the extruder bowden
gcode:
  {% set TOOL=printer["gcode_macro TOOL_INIT"].tool %}
  {% set SPEED=printer["gcode_macro TOOL_INIT"].chameleon_speed %}
  {% set ACC=printer["gcode_macro TOOL_INIT"].chameleon_acc %}
  
  TOOL_SELECT TOOL=7
  
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  
  M117 "Move tool {TOOL} by 50"
  MANUAL_STEPPER stepper=chameleon1 MOVE=50 SPEED={SPEED} ACCEL={ACC}
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
 
  
  G92 E0
  M400


[gcode_macro PRE_LOAD_8]
description: Loads the filament 8 into the extruder bowden
gcode:
  {% set TOOL=printer["gcode_macro TOOL_INIT"].tool %}
  {% set SPEED=printer["gcode_macro TOOL_INIT"].chameleon_speed %}
  {% set ACC=printer["gcode_macro TOOL_INIT"].chameleon_acc %}
  
  TOOL_SELECT TOOL=8
  
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0

  M117 "Move tool {TOOL} by -50"
  MANUAL_STEPPER stepper=chameleon1 MOVE=-50 SPEED={SPEED} ACCEL={ACC}
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
 
  G92 E0
  M400

[gcode_macro PRE_LOAD_9]
description: Loads the filament 9 into the extruder bowden
gcode:
  {% set TOOL=printer["gcode_macro TOOL_INIT"].tool %}
  {% set SPEED=printer["gcode_macro TOOL_INIT"].chameleon_speed %}
  {% set ACC=printer["gcode_macro TOOL_INIT"].chameleon_acc %}
  
  TOOL_SELECT TOOL=9
  
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
 
  M117 "Move tool {TOOL} by -50"
  MANUAL_STEPPER stepper=chameleon1 MOVE=-50 SPEED={SPEED} ACCEL={ACC}
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0

  G92 E0
  M400

[gcode_macro SELECT_TOOL]
rename_existing: SELECT_TOOL1
gcode:
  
    {% set curtool = params.T | int %}
     
   {% if curtool == 0 or curtool == 1 or curtool == 2 or curtool == 3 or curtool == 4 or curtool == 5 %}
    SELECT_TOOL1 T={curtool}
    
    {% else %}
     SELECT_TOOL1 T=5
     H{params.T}.1
   {% endif %}
 

[gcode_macro _global_var]
variable_pause_park:{'x': 30, 'y': 300, 'z': 10, 'e': 1}
variable_cancel_park:{'x': 30, 'y': 300, 'z': 10, 'e': 1}
variable_z_maximum_lifting_distance: 345
variable_pause_resume_travel_speed: 150
variable_bed_mesh_calibrate_target_temp: 60
variable_load_filament_extruder_temp: 220
gcode:

[gcode_macro TOOL_INIT]
description: homes the tool selector. Needed before any tool change.
variable_tool: 10
variable_ysplit_distance: 1780 #600
variable_chameleon_speed: 60
variable_chameleon_acc:50
variable_restore: 10
gcode:
  MANUAL_STEPPER STEPPER=selector1 SET_POSITION=0 
  MANUAL_STEPPER STEPPER=selector1 MOVE=-1.65
  MANUAL_STEPPER STEPPER=selector1 SET_POSITION=0 
  MANUAL_STEPPER STEPPER=selector1 MOVE=0.16 #.12
  MANUAL_STEPPER STEPPER=selector1 SET_POSITION=0 
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0 
  SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=tool VALUE=10 #-1


[gcode_macro _Clippy_Chop]
description: Perform the clippy chop.
variable_clippy_servo_name: 'clippy'
variable_clippy_minimum_angle: 120 # Idle position
variable_clippy_cut_angle: 0 # Cutting position
variable_x_cut_position: 2.0 # Position for the cut
gcode:
 G90
 G1 X15 Y338.19 F16000
 SET_TMC_CURRENT STEPPER=stepper_x CURRENT=2.0
 SET_TMC_CURRENT STEPPER=stepper_y CURRENT=2.0
 SET_SERVO SERVO={clippy_servo_name} ANGLE={clippy_cut_angle}
 M400
 G1 X{x_cut_position} F300
 G4 P1450
 G1 X80 F16000
 SET_SERVO SERVO={clippy_servo_name} ANGLE={clippy_minimum_angle}
 SET_TMC_CURRENT STEPPER=stepper_x CURRENT=1.13
 SET_TMC_CURRENT STEPPER=stepper_y CURRENT=1.13

 
[gcode_macro TS6]
gcode:
  TOOL_SELECT TOOL=6

[gcode_macro TS7]
gcode:
  TOOL_SELECT TOOL=7

[gcode_macro TS8]
gcode:
  TOOL_SELECT TOOL=8

[gcode_macro TS9]
gcode:
  TOOL_SELECT TOOL=9


[gcode_macro TOOL_SELECT]
gcode:
  {% set TOOL = params.TOOL|int %}
  M117 "Setting tool to TOOL{TOOL}"
  {% if TOOL == 6 %}
    MANUAL_STEPPER stepper=selector1 MOVE=0
  {% elif TOOL == 7 %}
    MANUAL_STEPPER stepper=selector1 MOVE=0.5
  {% elif TOOL == 8 %}
    MANUAL_STEPPER stepper=selector1 MOVE=1.0
  {% elif TOOL == 9 %}
    MANUAL_STEPPER stepper=selector1 MOVE=1.5
  {% endif %}
  SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=tool VALUE={TOOL}

[gcode_macro TOOL_FREE]
gcode:
  {% set TOOL = params.TOOL|int %}
  M117 "Free filament path for tool {TOOL}"
  {% if TOOL == 6 %}
    MANUAL_STEPPER stepper=selector1 MOVE=1 
  {% elif TOOL == 7 %}
    MANUAL_STEPPER stepper=selector1 MOVE=1.5
  {% elif TOOL == 8 %}
    MANUAL_STEPPER stepper=selector1 MOVE=0
  {% elif TOOL == 9 %}
    MANUAL_STEPPER stepper=selector1 MOVE=0.5
  {% endif %}
  


[gcode_macro CHAMELEON_UNLOAD]
description: Unloads the filament from the tubing
gcode:
  {% set TOOL=printer["gcode_macro TOOL_INIT"].tool %}
  {% set YSPLIT_DIST=printer["gcode_macro TOOL_INIT"].ysplit_distance %}
  {% set SPEED=printer["gcode_macro TOOL_INIT"].chameleon_speed %}
  {% set ACC=printer["gcode_macro TOOL_INIT"].chameleon_acc %}
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  {% if TOOL == 6 or TOOL == 7 %}
  M117 "Move tool {TOOL} by -{YSPLIT_DIST}"
  MANUAL_STEPPER stepper=chameleon1 MOVE=-{YSPLIT_DIST} SPEED={SPEED} ACCEL={ACC} SET_POSITION=0 SYNC=0
   G92 E0
   G1 E-130 F3600
   MANUAL_STEPPER STEPPER=chameleon1 SYNC=1
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  #MANUAL_STEPPER stepper=chameleon1 MOVE=-{YSPLIT_DIST} SPEED={SPEED} ACCEL={ACC}
  {% elif TOOL == 8 or TOOL == 9 %}
  M117 "Move tool {TOOL} by {YSPLIT_DIST}"
  MANUAL_STEPPER stepper=chameleon1 MOVE={YSPLIT_DIST} SPEED={SPEED} ACCEL={ACC} SET_POSITION=0 SYNC=0
   G92 E0
   G1 E-130 F3600
   MANUAL_STEPPER STEPPER=chameleon1 SYNC=1
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  G92 E0
  #MANUAL_STEPPER stepper=chameleon1 MOVE={YSPLIT_DIST} SPEED={SPEED} ACCEL={ACC}
  {% endif %}
  

# [gcode_macro CHAMELEON_UNLOAD]
# description: Unloads the filament from the tubing
# gcode:
#   {% set TOOL=printer["gcode_macro TOOL_INIT"].tool %}
#   {% set YSPLIT_DIST=printer["gcode_macro TOOL_INIT"].ysplit_distance %}
#   {% set SPEED=printer["gcode_macro TOOL_INIT"].chameleon_speed %}
#   {% set ACC=printer["gcode_macro TOOL_INIT"].chameleon_acc %}
#   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
#   {% if TOOL == 6 or TOOL == 7 %}
#   M117 "Move tool {TOOL} by -{YSPLIT_DIST}"
#   MANUAL_STEPPER stepper=chameleon1 MOVE=-{YSPLIT_DIST} SPEED={SPEED} ACCEL={ACC}
#   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
#   #MANUAL_STEPPER stepper=chameleon1 MOVE=-{YSPLIT_DIST} SPEED={SPEED} ACCEL={ACC}
#   {% elif TOOL == 8 or TOOL == 9 %}
#   M117 "Move tool {TOOL} by {YSPLIT_DIST}"
#   MANUAL_STEPPER stepper=chameleon1 MOVE={YSPLIT_DIST} SPEED={SPEED} ACCEL={ACC}
#   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
#   G92 E0
#   #MANUAL_STEPPER stepper=chameleon1 MOVE={YSPLIT_DIST} SPEED={SPEED} ACCEL={ACC}
#   {% endif %}
  

[gcode_macro CHAMELEON_LOAD]
description: Loads the filament into the extruder bowden
gcode:
  {% set TOOL=printer["gcode_macro TOOL_INIT"].tool %}
  {% set YSPLIT_DIST=printer["gcode_macro TOOL_INIT"].ysplit_distance %}
  {% set SPEED=printer["gcode_macro TOOL_INIT"].chameleon_speed %}
  {% set ACC=printer["gcode_macro TOOL_INIT"].chameleon_acc %}
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  {% if TOOL == 6 or TOOL == 7 %}
  M117 "Move tool {TOOL} by {YSPLIT_DIST}"
  MANUAL_STEPPER stepper=chameleon1 MOVE={YSPLIT_DIST} SPEED={SPEED} ACCEL={ACC}
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  #MANUAL_STEPPER stepper=chameleon1 MOVE={YSPLIT_DIST+1} SPEED={SPEED} ACCEL={ACC}
  #MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
 {% elif TOOL == 8 or TOOL == 9 %}
  M117 "Move tool {TOOL} by -{YSPLIT_DIST}"
  MANUAL_STEPPER stepper=chameleon1 MOVE=-{YSPLIT_DIST} SPEED={SPEED} ACCEL={ACC}
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  #MANUAL_STEPPER stepper=chameleon1 MOVE=-{YSPLIT_DIST+1} SPEED={SPEED} ACCEL={ACC}
  #MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  {% endif %}
  LOAD_FILAMENT
  G92 E0
  M400
  
[gcode_macro _EXTRUDER_UNLOAD]
description: Unloads the filament from the extruder before a tool change
gcode:

  M83
  G92 E0
  G1 E-2 F300
  _Clippy_Chop
  G92 E0
  G1 E-100 F450
  G92 E0
  {action_respond_info("Extruder Unloaded")}
  

[gcode_macro EXTRUDER_LOAD]
description: Loads the filament in the extruder after a tool change
gcode:
 
  M83
  M106 S255
  G92 E0
  G1 E100 F600 #10
  G92 E0
  G1 E100 F600
  G92 E0
  G1 E-3 F250 #67
  M106 S0
  G92 E0
  {action_respond_info("Extruder Loaded")}
  
[gcode_macro TOOL_UNLOAD]
gcode:
 {% set RESTORE=printer["gcode_macro TOOL_INIT"].restore %}
 
  {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp  = printer.extruder.target|int %}
    M104 S{extruder_temp}
    M117 Nozzle heating...
    {action_respond_info("Nozzle not hot enough!")}
    {action_respond_info("Nozzle heating...")}
    M104 S{extruder_temp}
   
    
# fetch current tool
  {% set TOOL= printer["gcode_macro TOOL_INIT"].tool %}
  {% set YSPLIT_DIST=printer["gcode_macro TOOL_INIT"].ysplit_distance %}
  {% if RESTORE == 6 or RESTORE == 7 or RESTORE == 8 or RESTORE == 9 %}
    SELECT_TOOL1 T=5
    G92 E0
    M109 S190 T5
    _EXTRUDER_UNLOAD
    UNSELECT_TOOL
    TOOL_SELECT TOOL={TOOL}
    G4 P250
    CHAMELEON_UNLOAD
    TOOL_INIT  
    M104 S0
    G92 E0
    SELECT_TOOL1 T=0
    {action_respond_info("Tool Unloaded")}
  {% endif %}

   M400
 
   SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=restore VALUE=10
   M104 S0
   
[gcode_macro H6.1]
description: Changes the filament to that loaded in tool 6
gcode:
 {% set RESTORE=printer["gcode_macro TOOL_INIT"].restore %}
 
 {% if RESTORE == 6 %}
  {% else %}
   
   {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp  = printer.extruder.target|int %}

    {% if printer.print_stats.state != "printing" %}
        {% if printer.print_stats.state != "paused" %}
            M104 S{extruder_temp}
            M117 Nozzle heating...
            {action_respond_info("Nozzle not hot enough!")}
            {action_respond_info("Nozzle heating...")}
            M109 S{extruder_temp}
        {% else %}
            {% if printer.extruder.target == 0 %}
                M104 S{extruder_temp}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{extruder_temp}
            {% else %}
                M104 S{printer.extruder.target}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{printer.extruder.target}
            {% endif %}
        {% endif %}
  
  # fetch current tool
      {% set TOOL= printer["gcode_macro TOOL_INIT"].tool %}
      {% set YSPLIT_DIST=printer["gcode_macro TOOL_INIT"].ysplit_distance %}
  
      {% if TOOL == 7 or TOOL == 8 or TOOL == 9 %}
      _EXTRUDER_UNLOAD
      UNSELECT_TOOL
      TOOL_SELECT TOOL={TOOL}
      CHAMELEON_UNLOAD
      
    {% endif %}

  # Select the new tool 
    {% set TOOL=6 %}
    SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=tool VALUE={TOOL}
    TOOL_SELECT TOOL={TOOL}
  
    UNSELECT_TOOL
    M109 S{extruder_temp} T5
    CHAMELEON_LOAD

   M83
   G92 E0
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
   MANUAL_STEPPER STEPPER=chameleon1 MOVE=130 SPEED=10 SET_POSITION=0 SYNC=0
   #MANUAL_STEPPER STEPPER=chameleon1 SYNC=0
   G1 E130 F600
   MANUAL_STEPPER STEPPER=chameleon1 SYNC=1
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0 
  
  # clear the path for the filament in the selector
  TOOL_FREE TOOL={TOOL}
  
  EXTRUDER_LOAD
  SELECT_TOOL1 T=5
  
 {action_respond_info("Tool 6 Loaded")}
 
  {% if current_target_temp == 0 or printer.print_stats.state != "paused"%}
            M104 S0
        {% endif %}
    {% else %}

 # fetch current tool
  {% set TOOL= printer["gcode_macro TOOL_INIT"].tool %}
  {% set YSPLIT_DIST=printer["gcode_macro TOOL_INIT"].ysplit_distance %}
  
  {% if TOOL == 7 or TOOL ==8 or TOOL ==9 %}
    _EXTRUDER_UNLOAD
    UNSELECT_TOOL
    TOOL_SELECT TOOL={TOOL}
    CHAMELEON_UNLOAD
    
  {% endif %}

  # Select the new tool 
  {% set TOOL=6 %}
  SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=tool VALUE={TOOL}
  TOOL_SELECT TOOL={TOOL}
  
  UNSELECT_TOOL
  M109 S{extruder_temp} T5
  CHAMELEON_LOAD

  M83
  G92 E0
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  MANUAL_STEPPER STEPPER=chameleon1 MOVE=130 SPEED=10 SET_POSITION=0 SYNC=0
  #MANUAL_STEPPER STEPPER=chameleon1 SYNC=0
  G1 E130 F600
  MANUAL_STEPPER STEPPER=chameleon1 SYNC=1
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  
  # clear the path for the filament in the selector
  TOOL_FREE TOOL={TOOL}
  
  EXTRUDER_LOAD
  SELECT_TOOL1 T=5 
  
 
 
        {action_respond_info("Tool 6 Loaded")}
   SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=restore VALUE=6
    {% endif %}
    SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=restore VALUE=6
     {% endif %}
     SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=restore VALUE=6


[gcode_macro H7.1]
description: Changes the filament to that loaded in tool 7
gcode:
 {% set RESTORE=printer["gcode_macro TOOL_INIT"].restore %}
 
 {% if RESTORE == 7 %}
  {% else %} 

 {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp  = printer.extruder.target|int %}

    {% if printer.print_stats.state != "printing" %}
        {% if printer.print_stats.state != "paused" %}
            M104 S{extruder_temp}
            M117 Nozzle heating...
            {action_respond_info("Nozzle not hot enough!")}
            {action_respond_info("Nozzle heating...")}
            M109 S{extruder_temp}
        {% else %}
            {% if printer.extruder.target == 0 %}
                M104 S{extruder_temp}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{extruder_temp}
            {% else %}
                M104 S{printer.extruder.target}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{printer.extruder.target}
            {% endif %}
        {% endif %}
  
  # fetch current tool
  {% set TOOL= printer["gcode_macro TOOL_INIT"].tool %}
  {% set YSPLIT_DIST=printer["gcode_macro TOOL_INIT"].ysplit_distance %}
  # Pause the print
  {% if TOOL == 6 or TOOL ==8 or TOOL ==9 %}
    _EXTRUDER_UNLOAD
    UNSELECT_TOOL
    TOOL_SELECT TOOL={TOOL}
    CHAMELEON_UNLOAD
    
  {% endif %}
  # Select the new tool 
  {% set TOOL=7 %}
  SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=tool VALUE={TOOL}
  TOOL_SELECT TOOL={TOOL}

  UNSELECT_TOOL
  M109 S{extruder_temp} T5
  CHAMELEON_LOAD
  
  M83
   G92 E0
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
   MANUAL_STEPPER STEPPER=chameleon1 MOVE=130 SPEED=10 SET_POSITION=0 SYNC=0
  #MANUAL_STEPPER STEPPER=chameleon1 SYNC=0
  G1 E130 F600
  MANUAL_STEPPER STEPPER=chameleon1 SYNC=1
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  # clear the path for the filament in the selector
  TOOL_FREE TOOL={TOOL}

  EXTRUDER_LOAD
  SELECT_TOOL1 T=5

  {action_respond_info("Tool 7 Loaded")}
   
  {% if current_target_temp == 0 or printer.print_stats.state != "paused"%}
            M104 S0
        {% endif %}
    {% else %}
        
        # fetch current tool
  {% set TOOL= printer["gcode_macro TOOL_INIT"].tool %}
  {% set YSPLIT_DIST=printer["gcode_macro TOOL_INIT"].ysplit_distance %}
  # Pause the print
  {% if TOOL == 6 or TOOL ==8 or TOOL ==9 %}
    _EXTRUDER_UNLOAD
    UNSELECT_TOOL
    TOOL_SELECT TOOL={TOOL}
    CHAMELEON_UNLOAD
    
  {% endif %}
  # Select the new tool 
  {% set TOOL=7 %}
  SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=tool VALUE={TOOL}
  TOOL_SELECT TOOL={TOOL}

  UNSELECT_TOOL
  M109 S{extruder_temp} T5
  CHAMELEON_LOAD
  
  M83
   G92 E0
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
   MANUAL_STEPPER STEPPER=chameleon1 MOVE=130 SPEED=10 SET_POSITION=0 SYNC=0
  # MANUAL_STEPPER STEPPER=chameleon1 SYNC=0
   G1 E130 F600
   MANUAL_STEPPER STEPPER=chameleon1 SYNC=1
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  
  # clear the path for the filament in the selector
  TOOL_FREE TOOL={TOOL}

  EXTRUDER_LOAD
  SELECT_TOOL1 T=5 

   

        {action_respond_info("Tool 7 Loaded")}
    SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=restore VALUE=7
    {% endif %}
    SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=restore VALUE=7
     {% endif %}
     SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=restore VALUE=7
     
[gcode_macro H8.1]
description: Changes the filament to that loaded in tool 8
gcode:
 {% set RESTORE=printer["gcode_macro TOOL_INIT"].restore %}
 
 {% if RESTORE == 8 %}
  {% else %}

  {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp  = printer.extruder.target|int %}

    {% if printer.print_stats.state != "printing" %}
        {% if printer.print_stats.state != "paused" %}
            M104 S{extruder_temp}
            M117 Nozzle heating...
            {action_respond_info("Nozzle not hot enough!")}
            {action_respond_info("Nozzle heating...")}
            M109 S{extruder_temp}
        {% else %}
            {% if printer.extruder.target == 0 %}
                M104 S{extruder_temp}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{extruder_temp}
            {% else %}
                M104 S{printer.extruder.target}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{printer.extruder.target}
            {% endif %}
        {% endif %}
  
  # fetch current tool
  {% set TOOL= printer["gcode_macro TOOL_INIT"].tool %}
  {% set YSPLIT_DIST=printer["gcode_macro TOOL_INIT"].ysplit_distance %}

  {% if TOOL == 6 or TOOL ==7 or TOOL ==9 %}
    _EXTRUDER_UNLOAD
    UNSELECT_TOOL
    TOOL_SELECT TOOL={TOOL}
    CHAMELEON_UNLOAD
    
  {% endif %}

  # Select the new tool 
  {% set TOOL=8 %}
  SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=tool VALUE={TOOL}
  TOOL_SELECT TOOL={TOOL}

  UNSELECT_TOOL
  M109 S{extruder_temp} T5
  CHAMELEON_LOAD

   M83
   G92 E0
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
   MANUAL_STEPPER STEPPER=chameleon1 MOVE=-130 SPEED=10 SET_POSITION=0 SYNC=0
   #MANUAL_STEPPER STEPPER=chameleon1 SYNC=0
   G1 E130 F600
   MANUAL_STEPPER STEPPER=chameleon1 SYNC=1
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  
  # clear the path for the filament in the selector
  TOOL_FREE TOOL={TOOL}

  EXTRUDER_LOAD
  SELECT_TOOL1 T=5
  
  {action_respond_info("Tool 8 Loaded")}
   
  {% if current_target_temp == 0 or printer.print_stats.state != "paused"%}
            M104 S0
        {% endif %}
    {% else %}
        
        # fetch current tool
  {% set TOOL= printer["gcode_macro TOOL_INIT"].tool %}
  {% set YSPLIT_DIST=printer["gcode_macro TOOL_INIT"].ysplit_distance %}

  {% if TOOL == 6 or TOOL ==7 or TOOL ==9 %}
    _EXTRUDER_UNLOAD
    UNSELECT_TOOL
    TOOL_SELECT TOOL={TOOL}
    CHAMELEON_UNLOAD
    
  {% endif %}

  # Select the new tool 
  {% set TOOL=8 %}
  SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=tool VALUE={TOOL}
  TOOL_SELECT TOOL={TOOL}

  UNSELECT_TOOL
  M109 S{extruder_temp} T5
  CHAMELEON_LOAD

   M83
   G92 E0
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
   MANUAL_STEPPER STEPPER=chameleon1 MOVE=-130 SPEED=10 SET_POSITION=0 SYNC=0
   #MANUAL_STEPPER STEPPER=chameleon1 SYNC=0
   G1 E130 F600
   MANUAL_STEPPER STEPPER=chameleon1 SYNC=1
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  
  # clear the path for the filament in the selector
  TOOL_FREE TOOL={TOOL}

  EXTRUDER_LOAD
  SELECT_TOOL1 T=5 

   

  {action_respond_info("Tool 8 Loaded")}
    SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=restore VALUE=8
    {% endif %}
    SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=restore VALUE=8
     {% endif %}
     SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=restore VALUE=8



[gcode_macro H9.1]
description: Changes the filament to that loaded in tool 9
gcode:
 {% set RESTORE=printer["gcode_macro TOOL_INIT"].restore %}
 
 {% if RESTORE == 9 %}
  {% else %}

  {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp  = printer.extruder.target|int %}

    {% if printer.print_stats.state != "printing" %}
        {% if printer.print_stats.state != "paused" %}
            M104 S{extruder_temp}
            M117 Nozzle heating...
            {action_respond_info("Nozzle not hot enough!")}
            {action_respond_info("Nozzle heating...")}
            M109 S{extruder_temp}
        {% else %}
            {% if printer.extruder.target == 0 %}
                M104 S{extruder_temp}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{extruder_temp}
            {% else %}
                M104 S{printer.extruder.target}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{printer.extruder.target}
            {% endif %}
        {% endif %}
  
  # fetch current tool
  {% set TOOL= printer["gcode_macro TOOL_INIT"].tool %}
  {% set YSPLIT_DIST=printer["gcode_macro TOOL_INIT"].ysplit_distance %}

  {% if TOOL == 6 or TOOL ==7 or TOOL ==8 %}
    _EXTRUDER_UNLOAD
    UNSELECT_TOOL
    TOOL_SELECT TOOL={TOOL}
    CHAMELEON_UNLOAD
    
  {% endif %}

  # Select the new tool 
  {% set TOOL=9 %}
  TOOL_SELECT TOOL={TOOL}
  SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=tool VALUE={TOOL}

  UNSELECT_TOOL
  M109 S{extruder_temp} T5
  CHAMELEON_LOAD

   M83
   G92 E0
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
   MANUAL_STEPPER STEPPER=chameleon1 MOVE=-130 SPEED=10 SET_POSITION=0 SYNC=0
   #MANUAL_STEPPER STEPPER=chameleon1 SYNC=0
   G1 E130 F600
   MANUAL_STEPPER STEPPER=chameleon1 SYNC=1
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  
  # clear the path for the filament in the selector
  TOOL_FREE TOOL={TOOL}

  EXTRUDER_LOAD
  SELECT_TOOL1 T=5 

  {action_respond_info("Tool 9 Loaded")}
   
  {% if current_target_temp == 0 or printer.print_stats.state != "paused"%}
            M104 S0
        {% endif %}
    {% else %}
       
 # fetch current tool
  {% set TOOL= printer["gcode_macro TOOL_INIT"].tool %}
  {% set YSPLIT_DIST=printer["gcode_macro TOOL_INIT"].ysplit_distance %}

  {% if TOOL == 6 or TOOL ==7 or TOOL ==8 %}
    _EXTRUDER_UNLOAD
    UNSELECT_TOOL
    TOOL_SELECT TOOL={TOOL}
    CHAMELEON_UNLOAD
    
  {% endif %}

  # Select the new tool 
  {% set TOOL=9 %}
  TOOL_SELECT TOOL={TOOL}
  SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=tool VALUE={TOOL}

  UNSELECT_TOOL
  M109 S{extruder_temp} T5
  CHAMELEON_LOAD

   M83
   G92 E0
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
   MANUAL_STEPPER STEPPER=chameleon1 MOVE=-130 SPEED=10 SET_POSITION=0 SYNC=0
   #MANUAL_STEPPER STEPPER=chameleon1 SYNC=0
   G1 E130 F600
   MANUAL_STEPPER STEPPER=chameleon1 SYNC=1
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  
  # clear the path for the filament in the selector
  TOOL_FREE TOOL={TOOL}

  EXTRUDER_LOAD
  SELECT_TOOL1 T=5 

   

        {action_respond_info("Tool 9 Loaded")}
    SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=restore VALUE=9
    {% endif %}
    SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=restore VALUE=9
     {% endif %}
     SET_GCODE_VARIABLE MACRO=TOOL_INIT VARIABLE=restore VALUE=9