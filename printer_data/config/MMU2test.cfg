[save_variables]
filename: ~/printer_data/config/variablesmmu.cfg


[gcode_macro Quick_Tip_Shaping]
gcode:
  {% set moves = params.MOVES | default(3) | int %}
  M83
  {% for _ in range(moves) %}
  G92 E0
  G1 E10 F1500
  G92 E0
  G1 E-15 F1500
  {% endfor %}
  G1 E-60 F2000
#QUICK_TIP_SHAPING MOVES=3

[gcode_macro _global_var]
variable_pause_park:{'x': 30, 'y': 300, 'z': 10, 'e': 1}
variable_cancel_park:{'x': 30, 'y': 300, 'z': 10, 'e': 1}
variable_z_maximum_lifting_distance: 345
variable_pause_resume_travel_speed: 150
variable_bed_mesh_calibrate_target_temp: 60
variable_load_filament_extruder_temp: 220
gcode:

[gcode_macro T6]
variable_color: ""
variable_tool: 6
gcode:
  SELECT_TOOL T=5
  H6.1

[gcode_macro T7]
variable_color: ""
variable_tool: 7
gcode:
  SELECT_TOOL T=5
  H7.1

[gcode_macro T8]
variable_color: ""
variable_tool: 8
gcode:
  SELECT_TOOL T=5
  H8.1

[gcode_macro T9]
variable_color: ""
variable_tool: 9
gcode:
  SELECT_TOOL T=5
  H9.1
  
[gcode_macro Clippy_Cut]
gcode:
  SET_SERVO SERVO=clippy ANGLE=0

[gcode_macro Clippy_Release]
gcode:
  SET_SERVO SERVO=clippy ANGLE=120

[gcode_macro _Clippy_Chop]
description: Perform the clippy chop.
variable_clippy_servo_name: 'clippy'
variable_clippy_minimum_angle: 120 # Idle position
variable_clippy_cut_angle: 0 # Cutting position
variable_x_cut_position: 2.0 # Position for the cut
gcode:
 G90
 G1 X15 Y338.19 F16000
 SET_TMC_CURRENT STEPPER=stepper_x CURRENT=2.0
 SET_TMC_CURRENT STEPPER=stepper_y CURRENT=2.0
 SET_SERVO SERVO={clippy_servo_name} ANGLE={clippy_cut_angle}
 G1 X{x_cut_position} F300
 G4 P1450
 G1 X80 F16000
 SET_SERVO SERVO={clippy_servo_name} ANGLE={clippy_minimum_angle}
 SET_TMC_CURRENT STEPPER=stepper_x CURRENT=1.13
 SET_TMC_CURRENT STEPPER=stepper_y CURRENT=1.13


# [gcode_macro _Clippy_Chop]
# gcode:
#  description: Perform the clippy chop.
# variable_clippy_servo_name: 'clippy'
# variable_clippy_minimum_angle: 120 # The idle angle of the arm, when not in use, usually 0.
# variable_clippy_cut_angle: 0 # The angle to turn the servo to perform the cut.
# gcode:
#  G90
#  G1 Y338.19 F16000
#  G1 X100 F16000
#  SET_SERVO SERVO={clippy_servo_name} ANGLE={clippy_cut_angle}
#  SET_TMC_CURRENT STEPPER=stepper_x CURRENT=2.0
#  SET_TMC_CURRENT STEPPER=stepper_y CURRENT=2.0
#  G1 X12.19 F16000
#  G1 X2.0 F300
#  G4 P2450
#  G1 X80 F16000
#  SET_SERVO SERVO={clippy_servo_name} ANGLE={clippy_minimum_angle}
#  SET_TMC_CURRENT STEPPER=stepper_x CURRENT=1.13
#  SET_TMC_CURRENT STEPPER=stepper_y CURRENT=1.13

[gcode_macro TOOL_INIT]
description: homes the tool selector. Needed before any tool change.
variable_tool: 10
variable_ysplit_distance: 2140 #600
variable_chameleon_speed: 60
variable_chameleon_acc:50
variable_restore: 10
gcode:
  {% if restore == 10 %}
  
  MANUAL_STEPPER STEPPER=selector1 SET_POSITION=0 
  MANUAL_STEPPER STEPPER=selector1 MOVE=-1.65
  MANUAL_STEPPER STEPPER=selector1 SET_POSITION=0 
  MANUAL_STEPPER STEPPER=selector1 MOVE=0.155 #.12
  MANUAL_STEPPER STEPPER=selector1 SET_POSITION=0 
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0 

 {% set restore = 101 %}
  SAVE_VARIABLE VARIABLE=restore VALUE="10"
  {% elif restore == 6 %}
   MANUAL_STEPPER STEPPER=selector1 SET_POSITION=0 
  MANUAL_STEPPER STEPPER=selector1 MOVE=-1.65
  MANUAL_STEPPER STEPPER=selector1 SET_POSITION=0 
  MANUAL_STEPPER STEPPER=selector1 MOVE=0.155 #.12
  MANUAL_STEPPER STEPPER=selector1 SET_POSITION=0 
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0 
  MANUAL_STEPPER stepper=selector1 MOVE=1
  {% set tool = 6 %}

  {% elif restore == 7 %}
   MANUAL_STEPPER STEPPER=selector1 SET_POSITION=0 
  MANUAL_STEPPER STEPPER=selector1 MOVE=-1.65
  MANUAL_STEPPER STEPPER=selector1 SET_POSITION=0 
  MANUAL_STEPPER STEPPER=selector1 MOVE=0.155 #.12
  MANUAL_STEPPER STEPPER=selector1 SET_POSITION=0 
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0 
  MANUAL_STEPPER stepper=selector1 MOVE=1.5
  {% set tool = 7 %}

   {% elif restore == 8 %}
   MANUAL_STEPPER STEPPER=selector1 SET_POSITION=0 
  MANUAL_STEPPER STEPPER=selector1 MOVE=-1.65
  MANUAL_STEPPER STEPPER=selector1 SET_POSITION=0 
  MANUAL_STEPPER STEPPER=selector1 MOVE=0.155 #.12
  MANUAL_STEPPER STEPPER=selector1 SET_POSITION=0 
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0 
  MANUAL_STEPPER stepper=selector1 MOVE=0.5
  {% set tool = 8 %}

   {% elif restore == 9 %}
   MANUAL_STEPPER STEPPER=selector1 SET_POSITION=0 
  MANUAL_STEPPER STEPPER=selector1 MOVE=-1.65
  MANUAL_STEPPER STEPPER=selector1 SET_POSITION=0 
  MANUAL_STEPPER STEPPER=selector1 MOVE=0.155 #.12
  MANUAL_STEPPER STEPPER=selector1 SET_POSITION=0 
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0 
  MANUAL_STEPPER stepper=selector1 MOVE=0
  {% set tool = 9 %}
 {% endif %}
  
 
[gcode_macro TS6]
gcode:
  TOOL_SELECT TOOL=6

[gcode_macro TS7]
gcode:
  TOOL_SELECT TOOL=7

[gcode_macro TS8]
gcode:
  TOOL_SELECT TOOL=8

[gcode_macro TS9]
gcode:
  TOOL_SELECT TOOL=9


[gcode_macro TOOL_SELECT]
gcode:
  {% set TOOL = params.TOOL|int %}
  M117 "Setting tool to TOOL{TOOL}"
  {% if TOOL == 6 %}
    MANUAL_STEPPER stepper=selector1 MOVE=0
  {% elif TOOL == 7 %}
    MANUAL_STEPPER stepper=selector1 MOVE=0.5
  {% elif TOOL == 9 %}
    MANUAL_STEPPER stepper=selector1 MOVE=1.0
  {% elif TOOL == 8 %}
    MANUAL_STEPPER stepper=selector1 MOVE=1.5
  {% endif %}
  {% set restore ="{TOOL}" %}
   SAVE_VARIABLE VARIABLE=restore VALUE="{TOOL}"

[gcode_macro TOOL_FREE]
gcode:
  {% set TOOL = params.TOOL|int %}
  M117 "Free filament path for tool {TOOL}"
  {% if TOOL == 6 %}
    MANUAL_STEPPER stepper=selector1 MOVE=1 
  {% elif TOOL == 7 %}
    MANUAL_STEPPER stepper=selector1 MOVE=1.5
  {% elif TOOL == 9 %}
    MANUAL_STEPPER stepper=selector1 MOVE=0
  {% elif TOOL == 8 %}
    MANUAL_STEPPER stepper=selector1 MOVE=0.5
  {% endif %}
  
[gcode_macro CHAMELEON_UNLOAD]
description: Unloads the filament from the tubing
gcode:
  {% set TOOL=printer["gcode_macro TOOL_INIT"].tool %}
  {% set YSPLIT_DIST=printer["gcode_macro TOOL_INIT"].ysplit_distance %}
  {% set SPEED=printer["gcode_macro TOOL_INIT"].chameleon_speed %}
  {% set ACC=printer["gcode_macro TOOL_INIT"].chameleon_acc %}
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  {% if TOOL == 6 or TOOL == 7 %}
  M117 "Move tool {TOOL} by -{YSPLIT_DIST}"
  MANUAL_STEPPER stepper=chameleon1 MOVE=-{YSPLIT_DIST} SPEED={SPEED} ACCEL={ACC}
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  #MANUAL_STEPPER stepper=chameleon1 MOVE=-{YSPLIT_DIST} SPEED={SPEED} ACCEL={ACC}
  {% elif TOOL == 8 or TOOL == 9 %}
  M117 "Move tool {TOOL} by {YSPLIT_DIST}"
  MANUAL_STEPPER stepper=chameleon1 MOVE={YSPLIT_DIST} SPEED={SPEED} ACCEL={ACC}
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  #MANUAL_STEPPER stepper=chameleon1 MOVE={YSPLIT_DIST} SPEED={SPEED} ACCEL={ACC}
  {% endif %}
  

[gcode_macro CHAMELEON_LOAD]
description: Loads the filament into the extruder bowden
gcode:
  {% set TOOL=printer["gcode_macro TOOL_INIT"].tool %}
  {% set YSPLIT_DIST=printer["gcode_macro TOOL_INIT"].ysplit_distance %}
  {% set SPEED=printer["gcode_macro TOOL_INIT"].chameleon_speed %}
  {% set ACC=printer["gcode_macro TOOL_INIT"].chameleon_acc %}
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  {% if TOOL == 6 or TOOL == 7 %}
  M117 "Move tool {TOOL} by {YSPLIT_DIST}"
  MANUAL_STEPPER stepper=chameleon1 MOVE={YSPLIT_DIST+5} SPEED={SPEED} ACCEL={ACC}
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  #MANUAL_STEPPER stepper=chameleon1 MOVE={YSPLIT_DIST+1} SPEED={SPEED} ACCEL={ACC}
  #MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
 {% elif TOOL == 8 or TOOL == 9 %}
  M117 "Move tool {TOOL} by -{YSPLIT_DIST}"
  MANUAL_STEPPER stepper=chameleon1 MOVE=-{YSPLIT_DIST+5} SPEED={SPEED} ACCEL={ACC}
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  #MANUAL_STEPPER stepper=chameleon1 MOVE=-{YSPLIT_DIST+1} SPEED={SPEED} ACCEL={ACC}
  #MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  {% endif %}
  G92 E0
  
  
[gcode_macro _EXTRUDER_UNLOAD]
description: Unloads the filament from the extruder before a tool change
gcode:
  
  G92 E0
  G1 E-2 F300
  _Clippy_Chop
  G92 E0
  G1 E-60 F400
  G92 E0
  {action_respond_info("Extruder Unloaded")}
  

[gcode_macro EXTRUDER_LOAD]
description: Loads the filament in the extruder after a tool change
gcode:
 
  G92 E0
  M106 S255
  G1 E100 F250 #10
  G92 E0
  G1 E60 F250
  G92 E0
  G1 E-3 F250 #67
  M106 S0
  G92 E0
  {action_respond_info("Extruder Loaded")}
  
[gcode_macro TOOL_UNLOAD]
gcode:
 {% set RESTORE=printer["gcode_macro TOOL_INIT"].restore %}
 
  {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp  = printer.extruder.target|int %}
    M104 S{extruder_temp}
    M117 Nozzle heating...
    {action_respond_info("Nozzle not hot enough!")}
    {action_respond_info("Nozzle heating...")}
    M104 S{extruder_temp}
   
    
# fetch current tool
  {% set TOOL= printer["gcode_macro TOOL_INIT"].tool %}
  {% set YSPLIT_DIST=printer["gcode_macro TOOL_INIT"].ysplit_distance %}
  {% if RESTORE == 6 or RESTORE == 7 or RESTORE == 8 or RESTORE == 9 %}
    T5
    G92 E0
    M109 S190 T5
    _EXTRUDER_UNLOAD
    UNSELECT_TOOL
    TOOL_SELECT TOOL={TOOL}
    G4 P250
    CHAMELEON_UNLOAD
    TOOL_INIT  
    M104 S0
    T0
    {action_respond_info("Tool Unloaded")}
  {% endif %}

   M400
 
 {% set restore = 10 %}
  SAVE_VARIABLE VARIABLE=restore VALUE="10"
   M104 S0
   
[gcode_macro H6.1]
description: Changes the filament to that loaded in tool 6
gcode:
 {% set RESTORE=printer["gcode_macro TOOL_INIT"].restore %}
 
 {% if RESTORE == 6 %}
  {% else %}
   
   {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp  = printer.extruder.target|int %}

    {% if printer.print_stats.state != "printing" %}
        {% if printer.print_stats.state != "paused" %}
            M104 S{extruder_temp}
            M117 Nozzle heating...
            {action_respond_info("Nozzle not hot enough!")}
            {action_respond_info("Nozzle heating...")}
            M109 S{extruder_temp}
        {% else %}
            {% if printer.extruder.target == 0 %}
                M104 S{extruder_temp}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{extruder_temp}
            {% else %}
                M104 S{printer.extruder.target}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{printer.extruder.target}
            {% endif %}
        {% endif %}
  
  # fetch current tool
      {% set TOOL= printer["gcode_macro TOOL_INIT"].tool %}
      {% set YSPLIT_DIST=printer["gcode_macro TOOL_INIT"].ysplit_distance %}
  
      {% if TOOL == 7 or TOOL == 8 or TOOL == 9 %}
      _EXTRUDER_UNLOAD
      UNSELECT_TOOL
      TOOL_SELECT TOOL={TOOL}
      CHAMELEON_UNLOAD
      
    {% endif %}

  # Select the new tool 
    {% set TOOL=6 %}
    SAVE_VARIABLE VARIABLE=tool VALUE="{TOOL}"
    TOOL_SELECT TOOL={TOOL}
  
    UNSELECT_TOOL
    M109 S{extruder_temp} T5
    CHAMELEON_LOAD

   M83
   G92 E0
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
   MANUAL_STEPPER STEPPER=chameleon1 MOVE=100 SPEED=10 SET_POSITION=0 SYNC=0
   #MANUAL_STEPPER STEPPER=chameleon1 SYNC=0
   G1 E100 F600
   MANUAL_STEPPER STEPPER=chameleon1 SYNC=1
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0 
  
  # clear the path for the filament in the selector
  TOOL_FREE TOOL={TOOL}
  
  EXTRUDER_LOAD
  T5
  
 {action_respond_info("Tool 6 Loaded")}
 M400
  {% if current_target_temp == 0 or printer.print_stats.state != "paused"%}
            M104 S0
        {% endif %}
    {% else %}

 # fetch current tool
  {% set TOOL= printer["gcode_macro TOOL_INIT"].tool %}
  {% set YSPLIT_DIST=printer["gcode_macro TOOL_INIT"].ysplit_distance %}
  
  {% if TOOL == 7 or TOOL ==8 or TOOL ==9 %}
    _EXTRUDER_UNLOAD
    UNSELECT_TOOL
    TOOL_SELECT TOOL={TOOL}
    CHAMELEON_UNLOAD
    
  {% endif %}

  # Select the new tool 
  {% set TOOL=6 %}
  SAVE_VARIABLE VARIABLE=tool VALUE="{TOOL}"
  TOOL_SELECT TOOL={TOOL}
  
  UNSELECT_TOOL
  M109 S{extruder_temp} T5
  CHAMELEON_LOAD

  M83
  G92 E0
  MANUAL_STEPPER STEPPER=chameleon1 MOVE=100 SPEED=10 SET_POSITION=0 SYNC=0
  #MANUAL_STEPPER STEPPER=chameleon1 SYNC=0
  G1 E100 F600
  MANUAL_STEPPER STEPPER=chameleon1 SYNC=1
  
  # clear the path for the filament in the selector
  TOOL_FREE TOOL={TOOL}
  
  EXTRUDER_LOAD
  T5 
  
 M400
 
        {action_respond_info("Tool 6 Loaded")}
   {% set restore =6 %}
  SAVE_VARIABLE VARIABLE=restore VALUE="6"
    {% endif %}
    {% set restore =6 %}
  SAVE_VARIABLE VARIABLE=restore VALUE="6"
     {% endif %}
     {% set restore =6 %}
  SAVE_VARIABLE VARIABLE=restore VALUE="6"


[gcode_macro H7.1]
description: Changes the filament to that loaded in tool 7
gcode:
 {% set RESTORE=printer["gcode_macro TOOL_INIT"].restore %}
 
 {% if RESTORE == 7 %}
  {% else %} 

 {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp  = printer.extruder.target|int %}

    {% if printer.print_stats.state != "printing" %}
        {% if printer.print_stats.state != "paused" %}
            M104 S{extruder_temp}
            M117 Nozzle heating...
            {action_respond_info("Nozzle not hot enough!")}
            {action_respond_info("Nozzle heating...")}
            M109 S{extruder_temp}
        {% else %}
            {% if printer.extruder.target == 0 %}
                M104 S{extruder_temp}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{extruder_temp}
            {% else %}
                M104 S{printer.extruder.target}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{printer.extruder.target}
            {% endif %}
        {% endif %}
  
  # fetch current tool
  {% set TOOL= printer["gcode_macro TOOL_INIT"].tool %}
  {% set YSPLIT_DIST=printer["gcode_macro TOOL_INIT"].ysplit_distance %}
  # Pause the print
  {% if TOOL == 6 or TOOL ==8 or TOOL ==9 %}
    _EXTRUDER_UNLOAD
    UNSELECT_TOOL
    TOOL_SELECT TOOL={TOOL}
    CHAMELEON_UNLOAD
    
  {% endif %}
  # Select the new tool 
  {% set TOOL=7 %}
  SAVE_VARIABLE VARIABLE=tool VALUE="{TOOL}"
  TOOL_SELECT TOOL={TOOL}

  UNSELECT_TOOL
  M109 S{extruder_temp} T5
  CHAMELEON_LOAD
  
  M83
   G92 E0
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
   MANUAL_STEPPER STEPPER=chameleon1 MOVE=100 SPEED=10 SET_POSITION=0 SYNC=0
  #MANUAL_STEPPER STEPPER=chameleon1 SYNC=0
  G1 E100 F600
  MANUAL_STEPPER STEPPER=chameleon1 SYNC=1
  MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  # clear the path for the filament in the selector
  TOOL_FREE TOOL={TOOL}

  EXTRUDER_LOAD
  T5

  {action_respond_info("Tool 7 Loaded")}
   M400
  {% if current_target_temp == 0 or printer.print_stats.state != "paused"%}
            M104 S0
        {% endif %}
    {% else %}
        
        # fetch current tool
  {% set TOOL= printer["gcode_macro TOOL_INIT"].tool %}
  {% set YSPLIT_DIST=printer["gcode_macro TOOL_INIT"].ysplit_distance %}
  # Pause the print
  {% if TOOL == 6 or TOOL ==8 or TOOL ==9 %}
    _EXTRUDER_UNLOAD
    UNSELECT_TOOL
    TOOL_SELECT TOOL={TOOL}
    CHAMELEON_UNLOAD
    
  {% endif %}
  # Select the new tool 
  {% set TOOL=7 %}
  SAVE_VARIABLE VARIABLE=tool VALUE="{TOOL}"
  TOOL_SELECT TOOL={TOOL}

  UNSELECT_TOOL
  M109 S{extruder_temp} T5
  CHAMELEON_LOAD
  
  M83
   G92 E0
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
   MANUAL_STEPPER STEPPER=chameleon1 MOVE=100 SPEED=10 SET_POSITION=0 SYNC=0
  # MANUAL_STEPPER STEPPER=chameleon1 SYNC=0
   G1 E100 F600
   MANUAL_STEPPER STEPPER=chameleon1 SYNC=1
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  
  # clear the path for the filament in the selector
  TOOL_FREE TOOL={TOOL}

  EXTRUDER_LOAD
  T5 

   M400

        {action_respond_info("Tool 7 Loaded")}
    {% set restore =7 %}
  SAVE_VARIABLE VARIABLE=restore VALUE="7"
    {% endif %}
    {% set restore =7 %}
  SAVE_VARIABLE VARIABLE=restore VALUE="7"
     {% endif %}
     {% set restore =7 %}
  SAVE_VARIABLE VARIABLE=restore VALUE="7"
     
[gcode_macro H8.1]
description: Changes the filament to that loaded in tool 8
gcode:
 {% set RESTORE=printer["gcode_macro TOOL_INIT"].restore %}
 
 {% if RESTORE == 8 %}
  {% else %}

  {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp  = printer.extruder.target|int %}

    {% if printer.print_stats.state != "printing" %}
        {% if printer.print_stats.state != "paused" %}
            M104 S{extruder_temp}
            M117 Nozzle heating...
            {action_respond_info("Nozzle not hot enough!")}
            {action_respond_info("Nozzle heating...")}
            M109 S{extruder_temp}
        {% else %}
            {% if printer.extruder.target == 0 %}
                M104 S{extruder_temp}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{extruder_temp}
            {% else %}
                M104 S{printer.extruder.target}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{printer.extruder.target}
            {% endif %}
        {% endif %}
  
  # fetch current tool
  {% set TOOL= printer["gcode_macro TOOL_INIT"].tool %}
  {% set YSPLIT_DIST=printer["gcode_macro TOOL_INIT"].ysplit_distance %}

  {% if TOOL == 6 or TOOL ==7 or TOOL ==9 %}
    _EXTRUDER_UNLOAD
    UNSELECT_TOOL
    TOOL_SELECT TOOL={TOOL}
    CHAMELEON_UNLOAD
    
  {% endif %}

  # Select the new tool 
  {% set TOOL=8 %}
 SAVE_VARIABLE VARIABLE=tool VALUE="{TOOL}"
  TOOL_SELECT TOOL={TOOL}

  UNSELECT_TOOL
  M109 S{extruder_temp} T5
  CHAMELEON_LOAD

   M83
   G92 E0
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
   MANUAL_STEPPER STEPPER=chameleon1 MOVE=-100 SPEED=10 SET_POSITION=0 SYNC=0
   #MANUAL_STEPPER STEPPER=chameleon1 SYNC=0
   G1 E100 F600
   MANUAL_STEPPER STEPPER=chameleon1 SYNC=1
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  
  # clear the path for the filament in the selector
  TOOL_FREE TOOL={TOOL}

  EXTRUDER_LOAD
  T5
  
  {action_respond_info("Tool 8 Loaded")}
   M400
  {% if current_target_temp == 0 or printer.print_stats.state != "paused"%}
            M104 S0
        {% endif %}
    {% else %}
        
        # fetch current tool
  {% set TOOL= printer["gcode_macro TOOL_INIT"].tool %}
  {% set YSPLIT_DIST=printer["gcode_macro TOOL_INIT"].ysplit_distance %}

  {% if TOOL == 6 or TOOL ==7 or TOOL ==9 %}
    _EXTRUDER_UNLOAD
    UNSELECT_TOOL
    TOOL_SELECT TOOL={TOOL}
    CHAMELEON_UNLOAD
    
  {% endif %}

  # Select the new tool 
  {% set TOOL=8 %}
  SAVE_VARIABLE VARIABLE=tool VALUE="{TOOL}"
  TOOL_SELECT TOOL={TOOL}

  UNSELECT_TOOL
  M109 S{extruder_temp} T5
  CHAMELEON_LOAD

   M83
   G92 E0
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
   MANUAL_STEPPER STEPPER=chameleon1 MOVE=-100 SPEED=10 SET_POSITION=0 SYNC=0
   #MANUAL_STEPPER STEPPER=chameleon1 SYNC=0
   G1 E100 F600
   MANUAL_STEPPER STEPPER=chameleon1 SYNC=1
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  
  # clear the path for the filament in the selector
  TOOL_FREE TOOL={TOOL}

  EXTRUDER_LOAD
  T5 

   M400

  {action_respond_info("Tool 8 Loaded")}
    {% set restore =8 %}
  SAVE_VARIABLE VARIABLE=restore VALUE="8"
    {% endif %}
    {% set restore =8 %}
  SAVE_VARIABLE VARIABLE=restore VALUE="8"
     {% endif %}
     {% set restore =8 %}
  SAVE_VARIABLE VARIABLE=restore VALUE="8"



[gcode_macro H9.1]
description: Changes the filament to that loaded in tool 9
gcode:
 {% set RESTORE=printer["gcode_macro TOOL_INIT"].restore %}
 
 {% if RESTORE == 9 %}
  {% else %}

  {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp  = printer.extruder.target|int %}

    {% if printer.print_stats.state != "printing" %}
        {% if printer.print_stats.state != "paused" %}
            M104 S{extruder_temp}
            M117 Nozzle heating...
            {action_respond_info("Nozzle not hot enough!")}
            {action_respond_info("Nozzle heating...")}
            M109 S{extruder_temp}
        {% else %}
            {% if printer.extruder.target == 0 %}
                M104 S{extruder_temp}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{extruder_temp}
            {% else %}
                M104 S{printer.extruder.target}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{printer.extruder.target}
            {% endif %}
        {% endif %}
  
  # fetch current tool
  {% set TOOL= printer["gcode_macro TOOL_INIT"].tool %}
  {% set YSPLIT_DIST=printer["gcode_macro TOOL_INIT"].ysplit_distance %}

  {% if TOOL == 6 or TOOL ==7 or TOOL ==8 %}
    _EXTRUDER_UNLOAD
    UNSELECT_TOOL
    TOOL_SELECT TOOL={TOOL}
    CHAMELEON_UNLOAD
    
  {% endif %}

  # Select the new tool 
  {% set TOOL=9 %}
  TOOL_SELECT TOOL={TOOL}
  SAVE_VARIABLE VARIABLE=tool VALUE="{TOOL}"

  UNSELECT_TOOL
  M109 S{extruder_temp} T5
  CHAMELEON_LOAD

   M83
   G92 E0
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
   MANUAL_STEPPER STEPPER=chameleon1 MOVE=-100 SPEED=10 SET_POSITION=0 SYNC=0
   #MANUAL_STEPPER STEPPER=chameleon1 SYNC=0
   G1 E100 F600
   MANUAL_STEPPER STEPPER=chameleon1 SYNC=1
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  
  # clear the path for the filament in the selector
  TOOL_FREE TOOL={TOOL}

  EXTRUDER_LOAD
  T5 

  {action_respond_info("Tool 9 Loaded")}
   M400
  {% if current_target_temp == 0 or printer.print_stats.state != "paused"%}
            M104 S0
        {% endif %}
    {% else %}
       
 # fetch current tool
  {% set TOOL= printer["gcode_macro TOOL_INIT"].tool %}
  {% set YSPLIT_DIST=printer["gcode_macro TOOL_INIT"].ysplit_distance %}

  {% if TOOL == 6 or TOOL ==7 or TOOL ==8 %}
    _EXTRUDER_UNLOAD
    UNSELECT_TOOL
    TOOL_SELECT TOOL={TOOL}
    CHAMELEON_UNLOAD
    
  {% endif %}

  # Select the new tool 
  {% set TOOL=9 %}
  TOOL_SELECT TOOL={TOOL}
  SAVE_VARIABLE VARIABLE=tool VALUE="{TOOL}"

  UNSELECT_TOOL
  M109 S{extruder_temp} T5
  CHAMELEON_LOAD

   M83
   G92 E0
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
   MANUAL_STEPPER STEPPER=chameleon1 MOVE=-100 SPEED=10 SET_POSITION=0 SYNC=0
   #MANUAL_STEPPER STEPPER=chameleon1 SYNC=0
   G1 E100 F600
   MANUAL_STEPPER STEPPER=chameleon1 SYNC=1
   MANUAL_STEPPER STEPPER=chameleon1 SET_POSITION=0
  
  # clear the path for the filament in the selector
  TOOL_FREE TOOL={TOOL}

  EXTRUDER_LOAD
  T5 

   M400

        {action_respond_info("Tool 9 Loaded")}
    {% set restore =9 %}
  SAVE_VARIABLE VARIABLE=restore VALUE="9"
    {% endif %}
    {% set restore =9 %}
  SAVE_VARIABLE VARIABLE=restore VALUE="9"
     {% endif %}
     {% set restore =9 %}
  SAVE_VARIABLE VARIABLE=restore VALUE="9"